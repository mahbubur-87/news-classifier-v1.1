!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("wafer-module",[],t):"object"==typeof exports?exports["wafer-module"]=t():(e.wafer=e.wafer||{},e.wafer.wafers=e.wafer.wafers||{},e.wafer.wafers["wafer-module"]=t())}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var n=a[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="https://s.yimg.com/aaq/wf/",t(t.s="./src/entry.js")}({"./src/entry.js":function(e,t,a){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},u=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),f=function e(t,a,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,a,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},m=[],g=window.wafer,v=g.base,p=g.constants,h=g.utils,y=g.WaferBaseClass,_=h.convertNodeListToArray,E=h.findAncestor,w=h.getConfigFromJSONScriptNode,b=h.getTemplateContent,D=h.setTimeout,M=h.throttle,C=p.ATTR_PREFIX,A=["handleAdd","handleDrag","handleDragEnd","handleDragEnter","handleDragIndicatorFocusIn","handleDragLeave","handleDragOver","handleDragStart","handleDrop","handleMouseEnter","handleMouseleave","handleMoveDown","handleMoveToColumn","handleMoveUp","handleRemove"],O="wafer-module-drag-indicator",x=document.body,T=function(e){function t(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=a.selector,i=a.successClass;r(this,t);var l=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,{selector:o},{STATE_ATTRS:m})),s=e.getAttribute(C+"module-id"),d=e.getAttribute(C+"module-remove-delay")||"1000",u=e.getAttribute(C+"module-drag-image-elem"),f=e.getAttribute(C+"module-remove-self-on-delete"),g="true"===e.getAttribute("draggable"),p=w(e.getElementsByClassName("wafer-module-config")[0]),h=e.getElementsByClassName(O)[0],y=void 0;if(u&&(y=e.getElementsByClassName(u)[0]),A.forEach(function(e){l[e]=l[e].bind(l)}),l._util=c({},l._util,{config:p,contextMenuActiveIndex:0,contextMenuButtons:null,delay:d,dragElement:h,dragImageElem:y,elem:e,id:s,isDraggable:g,removeSelfOnDelete:null===f||void 0===f?1:Number(f),successClass:i}),l._state=l._state||{},g){var _=e.getAttribute(C+"module-drag-mouseenter-timeout")||100;l.addEventListeners(),l._util.dragMouseEnterTimeout=_,l._state=c({},l._state,{dragElem:null,dragProxy:null,focusDragElem:null,focusMenuElem:null,hoverTimeout:null,scrollStop:!0})}return e.classList.add(i),l.handleDragOver=M(l.handleDragOver,100),D(function(){l.addInstanceToIdMap(l),v.emitWaferEvent("module:added",{elem:e,meta:{id:s}})},l,0),l}return o(t,e),u(t,[{key:"removeDragDropOverCueFromAll",value:function(){var e=this._state.dragProxy;if(e){var t=e.parentNode;t&&t.removeChild(e)}_(document.getElementsByClassName("wafer-module-drop-over")).forEach(function(e){e.classList.remove("wafer-module-drop-over")})}},{key:"focus",value:function(){var e=this._util.dragElement;e&&D(function(){e.focus()},50,this)}},{key:"destroy",value:function(){var e,a=this._util,r=a.elem,n=a.id,o=a.isDraggable;v.emitWaferEvent("module:destroyed",{elem:r,meta:{id:n}}),o&&this.removeEventListeners();for(var i=arguments.length,l=Array(i),s=0;s<i;s++)l[s]=arguments[s];(e=f(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this)).call.apply(e,[this].concat(l))}},{key:"_closeContextMenu",value:function(){var e=this;D(function(){var t=e._state.focusMenuElem,a=e._util.elem;a&&a.classList.remove("wafer-module-context-menu-open"),t&&t.parentNode.removeChild(t),e._state.focusMenuElem=null,e._state.focusDragElem=null,e._state.contextMenuButtons=null},5,this)}},{key:"_pageScroll",value:function(e){var t=this,a=window.scrollY;window.scrollTo({top:a+e}),this._state.scrollStop||D(function(){t._pageScroll(e)},20,this)}},{key:"handleRemove",value:function(){var e=this,t=this._util,a=t.elem,r=t.delay,n=t.removeSelfOnDelete;a.classList.add("wafer-module-delete-in-progress"),D(function(){n&&(v.destroy(a),e.destroy(),a.parentNode.removeChild(a)),a.classList.remove("wafer-module-delete-in-progress")},r,this),this.didRemove(a)}},{key:"handleDrag",value:function(e){e.stopPropagation();var t=this._util.elem;this._state.scrollStop=!0,t.classList.add("wafer-module-drag-in-progress"),x.classList.add("wafer-module-drag-in-progress"),this.setDragElem(e.currentTarget),e.clientY<150&&(this._state.scrollStop=!1,this._pageScroll(-1))}},{key:"handleDragEnter",value:function(e){var t=e.currentTarget;this.getDragElem()!==t&&(this.removeDragDropOverCueFromAll(),t.classList.add("wafer-module-drop-over"))}},{key:"handleDragLeave",value:function(e){var t=e.clientX,a=e.clientY,r=e.currentTarget,n=r.parentNode.getBoundingClientRect();if(a<n.top||a>=n.bottom||t<n.left||t>=n.right){if(this.getDragElem()===r)return;r.classList.remove("wafer-module-drop-over")}}},{key:"handleDragEnd",value:function(e){var t=this._util.elem;this._state.scrollStop=!0,t.classList.remove("wafer-module-drag-in-progress"),x.classList.remove("wafer-module-drag-in-progress"),this.removeDragDropOverCueFromAll()}},{key:"handleDragOver",value:function(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}},{key:"handleDragStart",value:function(e){var t=this._util,a=t.dragImageElem,r=t.elem;if(e.dataTransfer.effectAllowed="move",a){var n=document.createElement("div");n.classList.add("wafer-module-drag-proxy"),n.appendChild(a.cloneNode(!0)),document.body.appendChild(n),n.style.width=r.offsetWidth+"px",e.dataTransfer.setDragImage(n,e.offsetX,n.offsetHeight/2),this._state.dragProxy=n}}},{key:"handleAdd",value:function(e){this._closeContextMenu(),this.handleAdd()}},{key:"handleMoveUp",value:function(e){this._closeContextMenu(),this._handleMoveUp(e)}},{key:"handleMoveDown",value:function(e){this._closeContextMenu(),this._handleMoveDown(e)}},{key:"handleMoveToColumn",value:function(e){this._closeContextMenu(),this._handleMoveToColumn(e)}},{key:"handleMouseEnter",value:function(){if(this._util.isDraggable){var e=this._util,t=e.elem,a=e.dragMouseEnterTimeout;this._state.hoverTimeout=D(function(){t.classList.add("wafer-module-drag-hover-enter")},a,this)}}},{key:"handleMouseleave",value:function(){var e=this._util,t=e.isDraggable,a=e.isDropOnly;if(t&&!a){var r=this._util.elem;clearTimeout(this._state.hoverTimeout,this),r.classList.remove("wafer-module-drag-hover-enter")}}},{key:"handleDragIndicatorFocusIn",value:function(e){this._state.focusDragElem=e.target}},{key:"handleKeyboardDown",value:function(e){var t=this._state.focusDragElem;if(t){var a=e.keyCode,r=e.target,n=r.classList,o=void 0;if(32===a&&n&&n.contains(O)){e.preventDefault();var i=E(this._util.elem,"wafer-module-drop-target");if(i){var l=b(i.getElementsByClassName("wafer-module-drag-context-menu")[0]);if(l){var s=this._util.elem,d=document.createElement("div");d.classList.add("wafer-module-drag-options-context-menu"),this._state.focusMenuElem=d,d.innerHTML=l;t.parentNode.appendChild(d),s.classList.add("wafer-module-context-menu-open");var c=this._state.contextMenuButtons=d.getElementsByTagName("button");this._state.contextMenuActiveIndex=0,o=c[this._state.contextMenuActiveIndex],o&&D(function(){o.focus()},100,this)}}}else if(!this._state.contextMenuButtons)return;var u=this._state.contextMenuActiveIndex;38===a?(e.preventDefault(),0===u?this._state.contextMenuActiveIndex=this._state.contextMenuButtons.length-1:--this._state.contextMenuActiveIndex,o=this._state.contextMenuButtons[this._state.contextMenuActiveIndex]):40===a&&(e.preventDefault(),u>=this._state.contextMenuButtons.length-1?this._state.contextMenuActiveIndex=0:++this._state.contextMenuActiveIndex,o=this._state.contextMenuButtons[this._state.contextMenuActiveIndex]),o?D(function(){o.focus()},100,this):this._closeContextMenu()}}},{key:"handleClickOutside",value:function(e){var t=this._state.focusDragElem;(0,e.waferComposedMap)().get(t)||this._closeContextMenu()}},{key:"handleDrop",value:function(e){var t=this.getDragElem();if(e.stopPropagation(),t){var a=e.currentTarget;if("true"!==a.getAttribute("draggable"))return;a.previousElementSibling===t?(a.parentElement.insertBefore(a,t),this.didDrag({dragElem:a,dropElem:t})):(a.parentElement.insertBefore(t,a),this.didDrag({dragElem:t,dropElem:a}))}}},{key:"config",get:function(){var e=this._util,t=e.config;return{config:void 0===t?{}:t,elem:e.elem,id:e.id}}}]),t}(y);T.events={click:[["wafer-module-add","handleAdd"],["wafer-module-move-down","handleMoveDown"],["wafer-module-move-to-column","handleMoveToColumn"],["wafer-module-move-up","handleMoveUp"],["wafer-module-remove","handleRemove"]],drag:[["_self","handleDrag"]],dragend:[["_self","handleDragEnd"]],dragenter:[["_self","handleDragEnter"]],dragleave:[["_self","handleDragLeave"]],dragover:[["_self","handleDragOver"]],dragstart:[["_self","handleDragStart"]],drop:[["_self","handleDrop"]],focusin:[[O,"handleDragIndicatorFocusIn"]],mouseenter:[[O,"handleMouseEnter"]],mouseleave:[[O,"handleMouseleave"]]};var k=T,N=window.wafer.utils,L=N.convertNodeListToArray,I=N.getWaferInstanceForElem,B={},P=L(document.getElementsByClassName("wafer-module-drop-target")),S=P.map(function(e){var t=e.getAttribute("data-wf-module-drop-target-config");try{t=JSON.parse(t)}catch(e){}return t=t||{},{elem:e,regionId:t.regionId}}),R=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[],a=e.packageId;return a&&(B[a]=!0),S.forEach(function(e){var a=e.elem,r=e.regionId;L(a.getElementsByClassName("wafer-module")).forEach(function(e,a){var n=I(e,"wafer-module"),o=n.instance,i=void 0===o?{}:o,l=i.config||{},s=l.config,d=s||{},c=d.id,u=d.pin,f=void 0!==u&&u,m=s||{},g=m.packageId;(g=g||c)&&t.push({id:g,pin:B[g]||f,rank:a,regionId:r})})}),t},j=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},W=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),F=function e(t,a,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,a,r)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(r)},U=window.wafer,H=U.base,J=U.utils,K=J.bindEvent,X=J.convertNodeListToArray,Y=J.fetchWithCache,q=J.findAncestor,V=J.getConfigFromJSONScriptNode,z=J.throttle,G=J.unbindEvent,Q=window.wafer.controllers.WaferBaseController,Z="wafer-module-drag-in-progress",$="wafer-module-drop-target",ee="wafer-module-set-active",te="wafer-module-added",ae="wafer-module-add-in-progress",re="wafer-module-error",ne=document.body,oe=void 0,ie=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.root,r=void 0===a?document:a,n=e.selector,o=e.successClass,i=void 0===o?"wafer-module-complete":o;l(this,t);var d=V(document.getElementById("wafer-module-config")),c={};d.bodyErrorClass=d.bodyErrorClass||re;var u=d.bodyErrorClass,f=d.modulesAdded,m=void 0===f?[]:f,g=d.moveAriaMessage;m.forEach(function(e){c[e]=!0});var v=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{root:r,selector:n,props:{selector:n,successClass:i},WaferClass:k})),p=v;v._util=j({},v._util,{moduleConfig:d}),v._state=j({},v._state,{activeElem:null,dragElem:null,dropTargetElementConfigMap:new Map,idInstanceMapping:new Map,lastTargetIndex:0,modulesAddedMap:c,proxyElem:null}),v.handleBodyDragover=v.handleBodyDragover.bind(v),v.handleBodyDrop=v.handleBodyDrop.bind(v),v.handleDragEnd=v.handleDragEnd.bind(v),v.handleDragLeave=z(v.handleDragLeave.bind(v)),K(document.body,"dragover",v.handleBodyDragover,{passive:!1}),K(document.body,"drop",v.handleBodyDrop),K(document.body,"dragend",v.handleDragEnd,{passive:!1}),K(document.body,"dragleave",v.handleDragLeave,{passive:!1});var h=d.enableSnapshotOnLoad,y=void 0===h||h;return k.prototype.addInstanceToIdMap=function(){var e=p._state.idInstanceMapping,t=this._util.id;e.has(t)||e.set(t,[]);var a=p._state.modulesAddedMap;e.get(t).push(this),a[t]&&e.get(t).forEach(function(e){if(!e._destroyed){e._util.elem.classList.add(te)}})},k.prototype.setDragElem=function(e){p._state.dragElem=e},k.prototype.getDragElem=function(){return p._state.dragElem},k.prototype.handleAdd=function(){var e=p._state.activeElem,t=!1;e||(t=!0,e=p.getActiveTarget());var a=q(e,"wafer-module"),r=q(e,$),n=this.config,o=n.config,i=n.id,l=this._util.elem;if(!l.classList.contains(ae)){l.classList.add(ae);var s=r&&r.getElementsByClassName("wafer-module"),d=0;if(a)d=X(a.parentNode.children).indexOf(a);else if(t)d=0;else{var f=s&&s.length||0;d=0===f?0:f+1}if(r){var m=p.getDropTargetConfig(r),g=j({},o,m);g.rank=d||0,this.focus(),p.handleInlineAddingModule(r,s,g.packageId||g.id||i,i,l,d,c,this).then(function(){var e=R(g);p.triggerAction({packageData:e})}).catch(function(e){ne.classList.add(u),l.classList.remove(ae),H.emitError({name:"WaferModule",elem:l,meta:{type:"addModuleActionFailed"},stack:e.stack})})}}},k.prototype.didDrag=function(){var e=p._state.dragElem;if(e){e.classList.remove(Z);var t=p._state.elementInstances,a=t.get(e)||{},r=a.instance;if(r){var n=this.config.elem,o=q(n,$);if(o){var i=p.getDropTargetConfig(o),l=r.config.config,s=e.parentNode.children,d=X(s).indexOf(e),c=j({},l,i,{rank:d}),f=l.name,m=i.name,v=R(c);if(f&&m&&g){var h=g.replace("[NAME]",f).replace("[DROP_NAME]",m).replace("[DROP_ITEMS_COUNT]",s.length).replace("[RANK]",d+1);H.liveAriaRegion.innerHTML=h}this.focus(),p.triggerAction({packageData:v}).catch(function(e){ne.classList.add(u),H.emitError({name:"WaferModule",elem:n,meta:{type:"dragdropModuleActionFailed"},stack:e.stack})}),H.emitWaferEvent("wafer:module:drop:complete",{elem:e,meta:{config:j({},l,i)}})}p._state.dragElem=null}}},k.prototype.didRemove=function(e){var t=p._state.idInstanceMapping,a=this._util,r=a.config,n=a.elem,o=a.id;if(c[o]&&t.has(o))for(var i=p._state.activeElem,l=t.get(o),s=l.length,d=q(i,"wafer-module"),f=s-1;f>=0;f--){var m=l[f];if(m._destroyed)t.get(o).splice(f,1);else{var g=m._util,v=g.elem,h=g.removeSelfOnDelete;if(h&&v!==e){if(d===v&&(p._state.activeElem=v.previousSibling,!p._state.activeElem)){var y=v.parentNode,_=y.getElementsByClassName(ee);p._state.activeElem=_[_.length-1]}H.destroy(v),m.destroy(),v.parentNode.removeChild(v),t.get(o).splice(f,1)}v.classList.remove(te)}}c[o]=!1,p.triggerAction({removedPackages:[r.packageId||r.id||o]}).catch(function(e){ne.classList.add(u),H.emitError({name:"WaferModule",elem:n,meta:{type:"removeModuleActionFailed"},stack:e.stack})}),r.removeMessage&&(H.liveAriaRegion.innerHTML=r.removeMessage),H.emitWaferEvent("wafer:module:deleted",{elem:n,meta:{config:{id:r.id||o}}})},k.prototype._handleMoveUp=function(){var e=this._util.elem,t=e.previousElementSibling;if(t){var a=this.config.config,r=a;e.parentNode.insertBefore(e,t);var n=R(r),o=q(e,$),i=X(o.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),l=a.name,s=p.getDropTargetConfig(o),d=s.name,c=i.indexOf(e);if(l&&d&&g){var f=g.replace("[NAME]",l).replace("[DROP_NAME]",d).replace("[DROP_ITEMS_COUNT]",i.length).replace("[RANK]",c+1);H.liveAriaRegion.innerHTML=f}this.focus(),p.triggerAction({packageData:n}).catch(function(t){ne.classList.add(u),H.emitError({name:"WaferModule",elem:e,meta:{type:"moveUpFailed"},stack:t.stack})}),H.emitWaferEvent("wafer:module:moveup:complete",{elem:e,meta:{config:a}})}},k.prototype._handleMoveDown=function(){var e=this._util.elem,t=q(e,$),a=X(t.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),r=a.indexOf(e),n=this.config.config,o=n;e.parentNode.insertBefore(a[r+1],e);var i=R(o),l=X(t.getElementsByClassName("wafer-module")),s=n.name,d=p.getDropTargetConfig(t),c=d.name,f=l.indexOf(e);if(s&&c&&g){var m=g.replace("[NAME]",s).replace("[DROP_NAME]",c).replace("[DROP_ITEMS_COUNT]",l.length).replace("[RANK]",f+1);H.liveAriaRegion.innerHTML=m}this.focus(),p.triggerAction({packageData:i}).catch(function(t){ne.classList.add(u),H.emitError({name:"WaferModule",elem:e,meta:{type:"moveDownFailed"},stack:t.stack})}),H.emitWaferEvent("wafer:module:movedown:complete",{elem:e,meta:{config:n}})},k.prototype._handleMoveToColumn=function(e){var t=e.target,a=this._util.elem,r=this.config.config,n=r,o=t.getAttribute("data-index");o=parseInt(o,10)||1;var i=document.getElementsByClassName($)[o-1],l=i.getElementsByClassName("wafer-module")[0]||i.children[0];l&&i.insertBefore(a,l);var s=R(n),d=q(a,$),c=X(d.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),f=r.name,m=p.getDropTargetConfig(d),v=m.name,h=c.indexOf(a);if(f&&v&&g){var y=g.replace("[NAME]",f).replace("[DROP_NAME]",v).replace("[DROP_ITEMS_COUNT]",c.length).replace("[RANK]",h+1);H.liveAriaRegion.innerHTML=y}this.focus(),p.triggerAction({packageData:s}).catch(function(e){ne.classList.add(u),H.emitError({name:"WaferModule",elem:a,meta:{type:"moveUpFailed"},stack:e.stack})}),H.emitWaferEvent("wafer:module:moveacrosscolumns:complete",{elem:a,meta:{config:r}})},v.sync(),y&&setTimeout(function(){var e=R();e.length&&v.triggerAction({packageData:e}).catch(function(e){})},100),v}return d(t,e),W(t,[{key:"handleInlineAddingModule",value:function(e,t,a,r,n,o,i,l){var s=this._util.moduleConfig,d=void 0===s?{}:s,c=d.addFetchUrl;return Y((void 0===c?"/?p_id=MODULE_ID":c).replace(/MODULE_ID/,a),{cacheStrategy:"cacheFirst"}).then(function(a){var s=a.html,d=document.createElement("div"),c=t.length&&t[o];i[r]=!0,n.classList.remove(ae),d.innerHTML=s;var u=d.children[0];if(c)e.insertBefore(u,t[o]);else{var f=e.children,m=o?f[f.length-1]:f[0];e.insertBefore(u,m)}if(H.sync(e),l){var g=l.config.config,v=void 0===g?{}:g,p=v.addMessage;l.focus(),p&&(H.liveAriaRegion.innerHTML=p)}}).catch(function(e){var t=d.bodyErrorClass;ne.classList.add(t),i[r]=!1,n.classList.remove(ae),H.emitError({name:"WaferModule",elem:n,meta:{type:"addModuleActionFailed"},stack:e.stack})})}},{key:"getActiveTarget",value:function(){var e=X(document.getElementsByClassName($));return e.length?(this._state.lastTargetIndex>=e.length&&(this._state.lastTargetIndex=0),e[this._state.lastTargetIndex++]):null}},{key:"handleEvent",value:function(e,a,r){if(F(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"handleEvent",this).call(this,e,a,r),r&&"click"===r.type){var n=r.target;n.className&&n.classList.contains(ee)&&(this._state.activeElem=n)}}},{key:"triggerAction",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=t.critical,r=void 0!==a&&a,n=this._util.moduleConfig,o=void 0===n?{}:n;return o.actionHost?this.getCrumb().then(function(t){if(!t)throw new Error("crumb not found");var a=o.actionHost,n=o.actionVersion,l=void 0===n?"v2":n,s=o.appId,d=o.experienceId,c=o.currentContainers,u=void 0===c?{}:c,f=o.propertyId,m=i({},f,{selectedContainer:d,containers:[j({id:d},e)],currentContainers:u}),g=a+"api/"+l+"/preferences/declared/common?appId="+s;return r&&(g+="&criticalWrite=true&criticalWriteTimeout=1200"),Y(g,{cache:0,clientHeaders:{Crumb:t},credentials:"include",method:"PUT",body:JSON.stringify(m)})}):Promise.resolve()}},{key:"getDropTargetConfig",value:function(e){var t=this._state.dropTargetElementConfigMap,a=t.get(e);if(!a)try{a=JSON.parse(e.getAttribute("data-wf-module-drop-target-config")),t.set(e,a)}catch(e){}return a}},{key:"getCrumb",value:function(){var e=this._util.moduleConfig,t=void 0===e?{}:e,a=t.crumb||oe;if(a)return Promise.resolve(a);var r=t.actionHost,n=t.appId;return Y(r+"api/v1/auth/crumb?appId="+n,{cache:0,credentials:"include"}).then(function(e){if(!(oe=e.crumb))throw new Error("crumb not found");return oe})}},{key:"handleBodyDragover",value:function(e){var t=e.target;if(t.classList.contains($)&&(e.preventDefault(),!this._state.proxyElem)){var a=document.createElement("div"),r=X(t.getElementsByClassName("wafer-module")),n=r.length;if(a.style.pointerEvents="none",a.classList.add("wafer-module-drop-proxy"),this._state.proxyElem=a,n){var o=r[n-1];t.insertBefore(a,o.nextSibling)}else t.insertBefore(a,t.children[0])}}},{key:"handleBodyDrop",value:function(e){var t=this._state.dragElem;if(t){var a=this._util.moduleConfig,r=void 0===a?{}:a,n=r.bodyErrorClass,o=r.moveAriaMessage,i=e.target;if(i.classList.contains($)){var l=this._state,s=l.elementInstances,d=l.dropTargetElementConfigMap,c=s.get(t)||{},u=c.instance,f=d.get(i);if(!f)try{f=JSON.parse(i.getAttribute("data-wf-module-drop-target-config")),d.set(i,f)}catch(e){}var m=X(i.getElementsByClassName("wafer-module")).filter(function(e){return e.getAttribute("draggable")}),g=m.length,v=void 0;if(g){var p=m[g-1];v=g,i.insertBefore(t,p.nextSibling)}else v=0,i.insertBefore(t,i.children[0]);var h=u.config.config,y=j({},h,f),_=R(y);this.triggerAction({packageData:_}).catch(function(e){ne.classList.add(n),H.emitError({name:"WaferModule",elem:t,meta:{type:"actionFailed"},stack:e.stack})});var E=h.name,w=f,b=w.name;if(E&&b&&o){var D=o.replace("[NAME]",E).replace("[DROP_NAME]",b).replace("[DROP_ITEMS_COUNT]",g).replace("[RANK]",v+1);H.liveAriaRegion.innerHTML=D}H.emitWaferEvent("wafer:module:drop:complete",{elem:t,meta:{config:y}})}}}},{key:"handleDragLeave",value:function(e){var t=e.target,a=this._state.proxyElem;a&&t.classList.contains($)&&(a.parentNode.removeChild(a),this._state.proxyElem=null)}},{key:"handleDragEnd",value:function(e){var t=this._state.proxyElem;if(t){var a=t.parentNode;a&&a.removeChild(t),this._state.proxyElem=null}}},{key:"destroy",value:function(e){F(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this,e),e||(G(document.body,"dragover",this.handleBodyDragover,{passive:!1}),G(document.body,"drop",this.handleBodyDrop),G(document.body,"dragend",this.handleDragEnd,{passive:!1}),G(document.body,"dragleave",this.handleDragLeave,{passive:!1}))}}]),t}(Q),le=ie;t.default=new le({selector:"wafer-module"})}})});